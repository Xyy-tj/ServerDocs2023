# 442 服务器配置

记录配置 Ubuntu 服务器的相关内容。

## 0x01 系统、驱动、CUDA

### 重装系统

-   依然适用 Ubuntu 桌面版。使用 Etcher 制作系统启动盘，进入 BIOS 设置启动顺序，进入重装程序。
-   Linux 中提供的虚拟终端默认有 6 个，其中第 1 个是图形界面，第 2 到 6 个则是字符界面。可以通过 Ctrl+Alt+F(1~6)组合键在不同的虚拟终端之间进行切换。
-   系统相关指令。

```sh
# system info
cat /proc/version
uname -a
lsb_release -a
locale
cat /etc/os-release

# time
cal
date

# progress
ps
top
kill

# disk usage
df -hl
```

### 安装 Nvidia 驱动

-   确认系统识别到了 N 卡。N 卡型号与 Ubuntu 版本大概匹配就行。

```sh
# show nvidia graphic card items
lspci | grep -i nvidia
```

-   禁用第三方驱动 nouveau。

```sh
# new .conf
sudo gedit /etc/modprobe.d/blacklist.conf

# add config
blacklist nouveau
options nouveau modeset=0

# refresh and reboot
sudo update-initramfs -u
sudo reboot

# checkup now, outputs ought to be none
lsmod | grep nouveau
```

-   添加依赖包。

```sh
# install compile depended packages
sudo apt install build-essential pkg-config xserver-xorg-dev linux-headers-`uname -r
sudo apt install gcc make
```

-   下载驱动安装程序，链接。`.run`文件。重启检查是否安装成功。

```sh
# switch to terminal mode
ctrl + alt + fn # f7 for GUI

# stop GUI service
sudo service lightdm stop

# chmod and install
sudo chmod +x NVIDIA-Linux-x86_64-450.27.run
sudo bash NVIDIA-Linux-x86_64-450.27.run –no-opengl-files –no-x-check –no-nouveau-check
# note: might be some minor warnings; no 32bit installations.

# reboot and check
sudo reboot
nvidia-smi
```

### 安装 CUDA

-   [下载](https://developer.nvidia.com/cuda-10.2-download-archive)CUDA 安装程序。`.run`文件。

```sh
# install
sudo bash cuda_10.2.xxx._linux.run
# note: cancel driver checkbox.
```

-   添加 CUDA 的环境变量。添加之后`source`一下，应该就可以用`nvcc -V`指令了。

```sh
export PATH="/usr/local/cuda-10.2/bin:$PATH"
export LD_LIBRARY_PATH="/usr/lcoal/cuda-10.2/lib64:$LD_LIBRARY_PATH"
```

-   检查版本。

```sh
# check cuda version
cat /usr/local/cuda/version.txt
nvcc -V
```

### 安装 cuDNN

-   [下载](https://developer.nvidia.com/rdp/cudnn-archive)cuDNN 压缩文件。`tgz`文件。复制到相应文件夹。

```sh
# unpack
tar -zxvf cudnn-10.2-linux-x64-v7.6.5.32.tgz

# cp
sudo cp cuda/include/cudnn.h /usr/local/cuda/include/
sudo cp cuda/lib64/libcudnn* /usr/local/cuda/lib64/
sudo chmod a+r /usr/local/cuda/include/cudnn.h
```

-   检查版本。

```sh
# check cudnn version
cat /usr/local/cuda/include/cudnn.h | grep CUDNN_MAJOR -A 2
```

## 0x02 用户、用户组、权限

### 权限管理

-   类 Linux 的系统都具有基本的权限管理。用户分组，组分权限，权限管理区分所有者、归属组、其他。一个文件只能归属于一个用户、组。使用`ls -l`指令查看文件权限。

```sh
$ ls -l .zshrc # -ld for folder
-rwxrwxrwx 1 tommy  staff  2259 Aug 14 12:27 .zshrc
# 10-digits, link times, owner, group, size, last modify time, file name
# digit 0: d,directroy -,regular file s,socket l,symbolic link
# b,block-oriented device file c,charcter-oriented device file
```

-   权限类型分为读、写、执行（r4、w2、x1）。使用`chmod`指令进行管理。支持数字替身。

```sh
chmod [options] [mode] [file]
# [options]: -R/--recursive, dir and files inside
# [mode]: [ugoa][[+-=][rwxX]]
# [mode]: 600,644,666,700,711,755,777

# examples:
chmod a+r,ug+w,o-w a.conf b.xml
chmod -R a+rw * # all files
chmod 777 mine.txt
```

### 用户、用户组管理

-   重装系统之后，第一次建立的账户是管理员账户，需要主动初始化 root 账户。使用管理员或 root 账户去创建其他普通账户。

```sh
sudo passwd root # change passwd for root
[sudo] password for nami-442: # admin passwd
...
```

-   查看一些用户信息与系统文件。

```sh
$ whoami # w
zfj

$ id zfj
uid=1027(zfj) gid=1028(zfj) groups=1028(zfj),0(root),27(sudo)

# files
cat /etc/passwd |grep username # user info
cat /etc/shadow |grep username # passwd info
cat /etc/group |grep groupname # group info

zfj:x:1027:0::/home/zfj:/home/linuxbrew/.linuxbrew/bin/zsh
# user info: name:x:uid:gid:others:login shell path

zfj:*****
# passwd info: name:hashpasswd

anaconda:x:id:hpc,zfj
# group info: name:x:gid:users
```

-   管理用户、用户组。

```sh
# manage
sudo adduser username # add user
sudo userdel -r username # delete user and home dir

sudo addgroup groupname # add group
sudo groupdel groupname # delete group

sudo adduser username groupname # add user to group
sudo gpasswd -d userName groupName # delete user from group

# maintain
passwd [login_user] # change passwd for current user
sudo usermod -g root [login_user] # change group
sudo usermod -s /home/linuxbrew/.linuxbrew/bin/zsh [login_user] # change login shell
```

### 权限清单

-   列个清单。

```sh
# users: uid username passwd
1001 hpc 123456
1002 zfj
1003
1004
1005
1006
1007
1008
1009
1010
1011
1012
1013

# groups
root:root  # root group
sudo:nami-442 # sudo group
anaconda:hpc,zfj
```

## 0x03 Shell、Apt、Linuxbrew

### Shell

-   Ubuntu 自带了很多 Shell 了。当然可以使用 Apt 或者 Linuxbrew 安装更多的 Shell。

```sh
cat /etc/shells # check added shells
echo $SHELL # check the shell in use
chsh -s /usr/local/bin/zsh # switch default shell
sudo vim /etc/shells # add shells
# /home/linuxbrew/.linuxbrew/bin/zsh
# /home/linuxbrew/.linuxbrew/bin/bash
```

### bash 配置文件

-   配置文件加载顺序如下。配置的时候，针对所有用户，配置/etc/profile，用户个人配置~/.bashrc。

```sh
# bash configs, load as following orders
/etc/profile
/etc/bashrc
~/.bash_profile
~/.bashrc
```

```sh
# /etc/profile or /etc/zshenv
# system-wide configurations
# 2020.08.12

# homebrew 2.24
eval $(/home/linuxbrew/.linuxbrew/bin/brew shellenv)
export HOMEBREW_BOTTLE_DOMAIN="https://mirrors.tuna.tsinghua.edu.cn/linuxbrew-bottles"
export HOMEBREW_NO_AUTO_UPDATE=true

# for root
export PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"

# cuda@10.2
export LD_LIBRARY_PATH=":/usr/local/cuda-10.2/lib64"
export PATH="$PATH:/usr/local/cuda-10.2/bin"
export CUDA_HOME=":/usr/local/cuda-10.2"

# conda basic
export PATH="$PATH:/opt/anaconda/bin"

# ruby 2.7
export PATH="$PATH:/home/linuxbrew/.linuxbrew/lib/ruby/gems/2.7.0/bin"

# openjdk@11
export PATH="/home/linuxbrew/.linuxbrew/opt/openjdk@11/bin:$PATH"

# node@12
export PATH="/home/linuxbrew/.linuxbrew/opt/node@12/bin:$PATH"

# go@1.13
export PATH="/home/linuxbrew/.linuxbrew/opt/go@1.13/bin:$PATH"
```

```sh
# ~/.bashrc
# uniform configs

# >>> conda initialize >>>
# !! Contents within this block are managed by 'conda init' !!
__conda_setup="$('/opt/anaconda/bin/conda' 'shell.bash' 'hook' 2> /dev/null)"
if [ $? -eq 0 ]; then
    eval "$__conda_setup"
else
    if [ -f "/opt/anaconda/etc/profile.d/conda.sh" ]; then
        . "/opt/anaconda/etc/profile.d/conda.sh"
    else
        export PATH="/opt/anaconda/bin:$PATH"
    fi
fi
unset __conda_setup
# <<< conda initialize <<<
```

### zsh 配置文件

-   配置的时候，针对所有用户，配置/etc/zshenv，用户个人配置~/.zshrc。

```sh
# zsh configs, load as following orders
/etc/zshenv
/etc/zprofile
~/.zprofile
~/.zshrc
```

```sh
# ~/.zshrc
# zfj zsh configuration
# last update: 20200814

# clear
clear

# Auto cd to folder without cd
setopt AUTO_CD

# Set history related
HISTFILE=${ZDOTDIR:-$HOME}/.zsh_history
setopt EXTENDED_HISTORY
SAVEHIST=100
HISTSIZE=50
setopt SHARE_HISTORY
setopt APPEND_HISTORY
setopt INC_APPEND_HISTORY
setopt HIST_EXPIRE_DUPS_FIRST
setopt HIST_IGNORE_DUPS
setopt HIST_FIND_NO_DUPS
setopt HIST_REDUCE_BLANKS

# Set auto correction
setopt CORRECT
setopt CORRECT_ALL

# main prompt
PROMPT="%~ %(?.%F{green}>.%F{red}>)%f"

# PROMPT suffix
PROMPT+=" "

# shell alias
alias clr="clear"
alias cls="clear"
alias cln="clear"
alias vimzrc="vim ~/.zshrc"

# env alias
alias ls="exa"
alias py="python3"
alias python="python3"
alias pip="pip3"
alias my="mysql -u root -p"
alias cas="conda activate std"
alias cab="conda activate"

# >>> conda initialize >>>
# !! Contents within this block are managed by 'conda init' !!
__conda_setup="$('/opt/anaconda/bin/conda' 'shell.zsh' 'hook' 2> /dev/null)"
if [ $? -eq 0 ]; then
    eval "$__conda_setup"
else
    if [ -f "/opt/anaconda/etc/profile.d/conda.sh" ]; then
        . "/opt/anaconda/etc/profile.d/conda.sh"
    else
        export PATH="/opt/anaconda/bin:$PATH"
    fi
fi
unset __conda_setup
# <<< conda initialize <<<
# cas
conda activate std
```

### Apt 管理器

-   管理器呢，最终要的就是换源。清华源测试不错。

```sh
# enable https
sudo apt install apt-transport-https ca-certificates

# edit config
cp /etc/apt/sources.list /etc/apt/sources_bak.list # make a backup
sudo vim /etc/apt/sources.list
sudo apt update
sudo apt list --upgradable
```

```sh
# system-wide apt configurations
# maintained by wootommy
# last update: 20200814

# tsinghua mirrors
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic main restricted universe multiverse
deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse
deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse
deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-security main restricted universe multiverse
deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-security main restricted universe multiverse
```

-   一些比较有意思的指令。

```sh
apt list --installed
apt list --upgradable

apt search pkgname*
apt show pkgname
apt install pkgname=version
apt remove pkgname
apt purge pkgname # remove settings
apt autoremove # auto

apt update # apt-self
apt upgrade # all pkgs
apt full-upgrade # auto remove old version if necessary
```

### Linuxbrew

-   东西不多，好东西不少。换源。
-   添加的环境变量在前面。
-   目前安装 mysql 会有一些问题。无奈换位了 apt 安装。

```sh
# brew git
git -C "$(brew --repo)" remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git

# macos
git -C "$(brew --repo homebrew/core)" remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git
git -C "$(brew --repo homebrew/cask)" remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-cask.git
git -C "$(brew --repo homebrew/cask-fonts)" remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-cask-fonts.git
git -C "$(brew --repo homebrew/cask-drivers)" remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-cask-drivers.git
export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles'

# linux
git -C "$(brew --repo homebrew/core)" remote set-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/linuxbrew-core.git
export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.tuna.tsinghua.edu.cn/linuxbrew-bottles

# update
brew update
```

-   一些终端命令行工具收集一下。

```sh
brew install zsh bash cmake make gcc gdb
brew install wget curl git vim neovim emacs ncdu slurm ack tpp icdiff autojump
brew install htop pstree pgrep pkill
brew install ag exa fd fzf thefuck tldr tree when awk lsd ccat jq shellcheck
brew install cowsay calcurse sl jp2a cmatrix figlet rig moreutils
brew install node@12 openjdk@11 ruby mycli

# ag/the_silver_searcher

# insult
sudo visudo
Defaults insults

# spacevim
curl -sLf https://spacevim.org/install.sh | bash
```

-   没有的还是要 apt 安装。

```sh
apt install nmon taskwarrior
apt install mysql
```

## 0x04 SSH 远程登录

配置 SSH 远程连接。

### SSH、openssh

-   SSH 为 Secure Shell 的缩写，由 IETF 的网络小组制定，为建立在应用层基础上的安全协议，专为远程登录会话和其他网络服务提供安全性的协议。
-   OpenSSH 是 SSH 协议的免费开源实现，提供了服务端后台程序和客户端工具，用来加密远程控制和文件传输过程中的数据，并由此来代替原来的类似服务。

### 配置 openssh

-   查看网络配置，主要查看 IP 地址。

```sh
# install network tools if not installed
sudo apt-get install net-tools
ifconfig

en0: flags=8863<UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST> mtu 1500
	...
	inet 192.168.1.101 netmask 0xffffff00 broadcast 192.168.1.255
	...
```

-   安装相应的客户端。进行配置。

```sh
# server and client
sudo apt install openssh-server openssh-client

# register and start service
systemctl enable ssh
systemctl start ssh
service ssh start
/etc/init.d/ssh start
```

-   还有很多的高级配置呀！例如限制 session 并发数量，限制端口，提升账户验证方式等。

```sh
# config file: /etc/ssh/sshd_config

Protocol 2,1 # ssh version 1 and 2
Host * # all IPs server
ListenAddress 0.0.0.0 # all IPs
Port 22 # default port
PasswordAuthentication yes # passwd
PermitEmptyPasswords no # no empty passwd
CheckHostIP yes # check DNS
LoginGraceTime 60 # passwd input time limit

Compression yes # compress commands
SyslogFacility AUTH # log
LogLevel INFO # log level
PermitRootLogin no # no root login
```

### 防火墙设置

-   最好是有一个防火墙的配置，推荐使用 firewalld。

```sh
# firewalld
sudo apt install firewalld

# manage ports
sudo firewall-cmd --permanent --add-port=22/tcp
sudo firewall-cmd --permanent --add-service=ssh

# check config
sudo firewall-cmd --list-all
```

### 刷新 DNS 与 IP

```sh
# hosts
sudo gedit /etc/hosts

# refresh
sudo /etc/init.d/dns-clean start
sudo /etc/init.d/networking restart
```

### 远程登录

-   内网或使用 VPN 才可以进入。

```sh
ssh zfj@100.64.212.206 # openUbu
ssh zfj@100.64.198.24 # openUbu
ssh nami-442@100.64.198.24 # tjnami442
```

## 0x05 SSH 管理进程

想用服务器跑代码自然免不了多进程管理。

### CPU、GPU 性能管理

```sh
# CPU
htop

# GPU
nvidia-smi
```

### 抓取进程号

```sh
ps [-A] [|grep zsh]
pstree
pgrep pname
```

### 控制优先级

```sh
renice level pid
```

### 管理进程

```sh
kill pid
pkill pname
killall pname
```

## 0x06 MySQL

```sh
# configuration files
mysql --help|grep 'my.cnf'
/etc/my.cnf /etc/mysql/my.cnf /home/linuxbrew/.linuxbrew/etc/my.cnf ~/.my.cnf

vim /home/linuxbrew/.linuxbrew/etc/my.cnf

自己添加的源安装的。
```

## 0x07 Anaconda

### 下载安装文件

-   官网[下载](https://www.anaconda.com/products/individual)。`.sh`文件。
-   切换到 root 账户执行安装。

```sh
# wget
wget https://repo.anaconda.com/archive/Anaconda3-2020.07-Linux-x86_64.sh

# sudo install
su root
bash Anaconda3-2020.07-Linux-x86_64.sh

Anaconda3 will now be installed into this location:
/root/anaconda3
  - Press ENTER to confirm the location
  - Press CTRL-C to abort the installation
  - Or specify a different location below
[/root/anaconda3] >>> /opt/anaconda # normal user will not be able to read /root

conda init
conda avtivate
channels
install with conda
conda create -n env_name
conda update -n env_name
sudo vim /etc/resolv.conf
sudo /etc/init.d/dns-clean start
```

## 0x08 配置 Jupyter

```sh
jupyter notebook --generate-config
```

## 0x09 Matlab

## 0x10 算力分配
